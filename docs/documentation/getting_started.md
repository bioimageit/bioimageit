# Getting started

<!-- This tutorial will explain the main features of BioImageIT so that you can easily build and share workflows.

This tutorial will show how to count the number of spot per nuclei on FISH (Fluorescence In Situ Hybridization) images, analyzing FOLS2 (green), CSF1R (red), and nuclei (blue) in breast cancer tissue. -->


![GUI](/docs/documentation/images/bioimageit.png)
*BioImageIT Graphical User Interface*

This tutorial will show how to analyse [FISH (Fluorescence In Situ Hybridization) images](https://www.cellimagelibrary.org/groups/13438) from the Cell Image Library. The objective will be to compute the average number of spots per nuclei, analyzing FOLS2 (green), CSF1R (red), and nuclei (blue) in breast cancer tissue.

Here is the different processing steps of the workflow:
- Convert the image to RGB (optional)
- Split the 3 channels
- Detect spots on channels 1 & 2
- Compute connected components to differenciate each spot
- Segment nuclei on channel 3 with SAM
- Compute the overlaps between detected spots and the nuclei
- Count the average number of spots per nuclei

![FISH image - Breast cells](/docs/documentation//images/breast.jpg)

## Prepare the data

Create a FISH folder on your computer, and download the following images in it:
 - https://cildata.crbs.ucsd.edu/media/images/13432/13432.tif
 - https://cildata.crbs.ucsd.edu/media/images/13434/13434.tif
 - https://cildata.crbs.ucsd.edu/media/images/13436/13436.tif
 - https://cildata.crbs.ucsd.edu/media/images/13438/13438.tif

## Create workflow

To create a workflow, go to the "Workflow" tab and click "New workflow". A dialog will open for you to create the folder of your workflow. Choose a location for the folder, enter "Tutorial" its name and save; BioImageIT will create the workflow folder.

All data generated by your workflow will be saved here and follow the following structure:
```
path/to/workflow/
├── Data
│   ├── Node 1          # Output data of node 1
│   ├── Node 2          # Output data of node 2
│   └── ...
├── Metadata
│   ├── Node 1          # Parameters and dataframe of node 1
│   ├── Node 2          # Parameters and dataframe of node 1
│   └── ...
├── Thumbnails
│   ├── Node 1          # Thumbnails of node 1 outputs
│   ├── Node 2          # Thumbnails of node 2 outputs
│   └── imageToThumbnail.json        # Map which links thumbails with original images
├── Tools
│   ├── Custom tool 1   # A tool designed specifically for the workflow
│   └── ...
└── workflow.pygraph    # The file which describe the workflow graph (DAG)
```

## Create nodes

Nodes are listed in the Tools tab, organized by categories. You can search for specific tools with the search bar. 

![Tools](/docs/documentation/images/tools.png)
*Tool library*

![Create node](/docs/documentation/images/create_node.png)

Choose the "List files" tool from this list and drag it to the canvas to add a node to the workflow.

Select the "List files" node, go to the "Properties" tab and set the "folderPath" parameter by using the browse button "...". Choose the FISH folder containing the images you downloaded.
The "List files" node will generate a dataframe from its parameters, containing one column named "path" with four file paths. You can filter those images with the "filter" parameter, and change the "columnName" to something more descriptive if you want but we will consider those untouched for the rest of the tutorial.

BioImageIT will generate image thumbnails (in the background, and in parallel) for any existing image path in the DataFrames.

You can see the resulting DataFrame with the image thumbnails in the "DataFrame" tab when you select the "List files" node. Click on one of the image to open it on Napari. This will create a Conda environment for Napari and install it if necessary (this could take a few minutes since it must install all Napari dependencies), then open the image.

!!! Use your own Napari installation

    You can also use your own Napari installation by specifying your Napari Environment in the "Preferences" window (File menu (BioImageIT menu on macOS) > Preferences... , then General tab > Common > Napari environment). This can be useful if you already have plugins installed in your Napari and you don't want to reinstall everything.

In Napari, you can see that the 3 components of the image are seperated in differente slices. Thus, the preview thumbnails generated by BioImageIT to display the DataFrame are mainly black. Instead, we would like the 3 components to be in the 3 RGB channels of the image. For that, we can use the "Convert image" tool in the "Format conversion" category.

Drag a "Convert image" node on the workflow, but don't connect it yet to the "List files" node.

Select the "Convert image" node, go to the "Properties" tab and use the browse button "..." to select the first FISH image for the "input_image" parameter. Open the advanced parameters and hover the "merge" parameter with your mouse for a second. A tooltip provides more information about the parameter: "Combine seperate channels into RGB image". Tick the parameter and execute the workflow by clicking the "Run unexecuted nodes" in the "Execution" tab. BioImageIT will execute the "Convert image" node on the selected image, and generate a new thumbnail for the resulting image. As you can see, the thumbnail (in the "Convert image: output_image" column) is now in color and much more informative. The node has turned green to indicate that the execution succeeded. It will turn orange if you modify its parameters to indicate that its output data is not up-to-date with the parameters anymore.

Connect the two nodes by draging the output pin of the first node to the input pin of the second node.

![Connect nodes](/docs/documentation/images/connect_nodes.png)


## Node parameterizing and DataFrames

The "Convert images" node receives the DataFrame generated by the "List files" node. This DataFrame will provide the file paths and other parameters necessary for the execution of the "Convert image" node. 

Click the "Convert images" node and notice that all its parameters have an additional "Constant / Column" dropdown to either set the parameter as a fixed value, or from a column. By default, the "input_image" is set to "Column", since we often want to convert a set of different images; and all others are set to "Constant", since we often want to apply the same kind of conversion on all images. 

When executed, the node will process all rows of the input DataFrame. The "Constant" parameters will remain constant for all rows, and the "Column" parameters will be set to the value of the row at the specified column. In our case, the "Convert image" tool will be executed  4 times, each time with a different "input_image" but with constant values for the other parameters ("merge" will be true for all images).

You can also notice that the output DataFrame of the "Convert image" node has two columns: 
- "path", which was created by "List files" node, 
- and "Convert image: output_image" which is the output image paths of the "Convert image" node.
The "output_image" parameter is "{input_image.stem}_ome.tiff" by default. BioImageIT will replace the value "{input_image.stem}" by the stem value (file name without extension) at the column "input_image". See more in the [Automatic output values]() section.

Execute the workflow to convert the 4 images.

Add 3 "Extract channel" nodes and connect them after the "Convert image" node. Set their "channel" parameter to a constant value of 0, 1 and 2 respectively ; and rename them accordingly by double-clicking on their name (on the node header on the canvas). Execute the workflow to extract the 3 images.

Create two "Atlas" nodes (from the "Detection" category), put them after the "Extract channel 0" & "Extract channel 1" nodes, and rename them accordingly. Set their "gaussian_std" parameters to 120, and their "p_value" parameters to 0,00001. See the [Finding optimal parameters in BioImageIT]() section to learn more about searching the parameters space.

Execute the workflow to detect the spots in channels 1 & 2.

Create two "Connected components" nodes (from the "SimpleITK > Custom" category), put them after the "Atlas 0" and "Atlas 1" nodes and rename them accordingly. Execute the workflow to detect the connected components.

Create a "Sam" node (from the "Segmentation" category) and put it after the "Extract channel 2" node. Execute the workflow to compute the sam detections.

Create two "Label overlaps" nodes (from "SimpleITK > Custom" category), put them after the "Connected components 0" and "Connected components 1" nodes, and rename them accordingly. Connect the output of the "Sam" node to their inputs. Make sure the input parameter "label1" is set to the "Sam: segmentation" column for both "Label overlaps" nodes, and "label2" is set to the "Connected component N: labeled_image" column (and not "Connected component N: labeled_image_rgb"). Execute the workflow to compute the overlaps. 

Note that unlike the nodes we used until now, the "Label overlaps" nodes do not generate new images. Yet, the DataFrame they generate is not filled with the output image paths, but with the details of the label overlaps. The "label 1" column lists the connected components of the first input image (the Sam segmentation of the nuclei in our case), the "label 2" column lists the connected components of the second input image (the Atlas spot detections) overlapping those nuclei. The "overlap" column corresponds to the number of pixels shared by the two connected components. Note that there are numerous connected components overlapping the label 1 in the Sam segmentation since it corresponds to the background. We will see how to filter those out in the next step.

